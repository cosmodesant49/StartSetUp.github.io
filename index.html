<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InstallerHub</title>
<style>
body{margin:0;font-family:Inter,sans-serif;background:#f8f8ff}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 60px;background:rgba(255,255,255,.9);border-bottom:1px solid #ddd}
.logo{font-size:22px;font-weight:700;color:#6a0dad}
nav{display:flex;gap:20px}
nav a{color:#333;text-decoration:none}
.profile button{border:1px solid #6a0dad;background:none;color:#6a0dad;padding:8px 14px;border-radius:8px;cursor:pointer}
h2{text-align:center;margin:40px 0}
main{padding:0 80px 60px;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:24px}
.card{background:#fff;border-radius:16px;padding:20px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.card img{width:80px;height:80px}
.actions{display:flex;gap:10px;justify-content:center;margin-top:15px}
.download{background:linear-gradient(90deg,#6a0dad,#9b4dff);color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none}
.collection{border:1px solid #6a0dad;background:rgba(106,13,173,.1);color:#6a0dad;padding:8px 14px;border-radius:8px;cursor:pointer}
.collection.added{background:#6a0dad;color:#fff}
footer{text-align:center;padding:20px;background:#fff;border-top:1px solid #ddd}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999}
.modal.active{display:flex}
.modal-box{background:#fff;padding:30px;border-radius:16px;width:360px}
.tabs{display:flex;margin-bottom:15px}
.tabs button{flex:1;border:none;padding:10px;background:#eee;cursor:pointer}
.tabs .active{background:#6a0dad;color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}
.tab-content input{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc}
.primary{width:100%;padding:10px;border:none;border-radius:10px;background:linear-gradient(90deg,#6a0dad,#9b4dff);color:#fff;cursor:pointer}
.collection-list{max-height:200px;overflow:auto}
.collection-item{padding:8px;border-bottom:1px solid #eee;font-size:14px}
</style>
</head>
<body>

<header>
<div class="logo">InstallerHub</div>
<nav>
<a href="#">Windows</a>
<a href="#">Linux</a>
<a href="#">Top</a>
</nav>
<div class="profile">
<button id="openAuth">Войти</button>
</div>
</header>

<h2>Популярные приложения</h2>
<main id="appList"></main>

<footer>© 2025 InstallerHub</footer>

<div class="modal" id="authModal">
<div class="modal-box">
<div class="tabs">
<button class="tab active" data-tab="login">Вход</button>
<button class="tab" data-tab="register">Регистрация</button>
<button class="tab" data-tab="collection">Коллекция</button>
</div>

<div class="tab-content active" id="login">
<input placeholder="Email">
<input type="password" placeholder="Пароль">
<button class="primary">Войти</button>
</div>

<div class="tab-content" id="register">
  <input placeholder="Имя пользователя">
  <input placeholder="Email">
  <input type="password" placeholder="Пароль">
  <input type="password" placeholder="Подтвердить пароль">
  <button class="primary">Создать аккаунт</button>
</div>


<div class="tab-content" id="collection">
<div class="collection-list" id="collectionList"></div>
</div>
</div>
</div>


<style>
.collection-item {
    display: flex;
    justify-content: space-between; /* название слева, кнопка справа */
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}

.collection-item .download {
    background: linear-gradient(90deg,#6a0dad,#9b4dff);
    color: #fff;
    padding: 4px 10px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 13px;
}
</style>
<script>
const modal = document.getElementById('authModal');
const openAuthBtn = document.getElementById('openAuth');

openAuthBtn.onclick = () => modal.classList.add('active');
modal.onclick = e => { if (e.target === modal) modal.classList.remove('active'); };

document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
        document.querySelectorAll('.tab,.tab-content').forEach(e => e.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'collection') renderCollection();
    };
});

let collection = [];  // коллекция объектов {id, name, download_url}

// ------------------- ФУНКЦИИ -------------------
async function fetchProfile() {
    const token = localStorage.getItem('token');
    if (!token) return [];

    try {
        const res = await fetch('https://cosmodesant.pythonanywhere.com/api/auth/profile/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return [];
        const data = await res.json();
        return data.favorite_apps || []; // массив ID
    } catch (err) {
        console.error(err);
        return [];
    }
}

function renderCollection() {
    const list = document.getElementById('collectionList');
    list.innerHTML = collection.length ? '' : '<p>Коллекция пуста</p>';

    collection.forEach(app => {
        const div = document.createElement('div');
        div.className = 'collection-item';
        div.innerHTML = `
            <span>${app.name}</span>
            <a class="download" href="${app.download_url}" target="_blank">Скачать</a>
        `;
        list.appendChild(div);
    });
}

// ------------------- LOGIN/REGISTER -------------------
const loginBtn = document.querySelector('#login .primary');
const registerBtn = document.querySelector('#register .primary');

loginBtn.onclick = async () => {
    const email = document.querySelector('#login input[placeholder="Email"]').value;
    const password = document.querySelector('#login input[type="password"]').value;

    try {
        const res = await fetch('https://cosmodesant.pythonanywhere.com/api/auth/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: email, password })
        });
        const data = await res.json();
        if (res.ok) {
            localStorage.setItem('token', data.access);
            alert('Вход успешен!');
            modal.classList.remove('active');
            await loadApps(); // обновляем кнопки
        } else {
            alert(JSON.stringify(data));
        }
    } catch (err) {
        console.error(err);
        alert('Ошибка входа');
    }
};

registerBtn.onclick = async () => {
    const username = document.querySelector('#register input[placeholder="Имя пользователя"]').value;
    const email = document.querySelector('#register input[placeholder="Email"]').value;
    const password = document.querySelector('#register input[placeholder="Пароль"]').value;
    const password2 = document.querySelector('#register input[placeholder="Подтвердить пароль"]').value;

    try {
        const res = await fetch('https://cosmodesant.pythonanywhere.com/api/auth/register/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password, password2 })
        });
        const data = await res.json();
        if (res.ok) {
            alert('Регистрация успешна! Войдите в систему');
            document.querySelector('.tab[data-tab="login"]').click();
        } else {
            alert(JSON.stringify(data));
        }
    } catch (err) {
        console.error(err);
        alert('Ошибка регистрации');
    }
};
async function fetchCollection() {
    const token = localStorage.getItem('token');
    if (!token) return [];

    try {
        // 1. Получаем favorite_apps (массив ID)
        const profileRes = await fetch('https://cosmodesant.pythonanywhere.com/api/auth/profile/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!profileRes.ok) return [];
        const profileData = await profileRes.json();
        const favoriteIds = profileData.favorite_apps || [];

        if (!favoriteIds.length) return [];

        // 2. Получаем все приложения
        const appsRes = await fetch('https://corsproxy.io/?https://Cosmodesant.pythonanywhere.com/apps/');
        if (!appsRes.ok) return [];
        const apps = await appsRes.json();

        // 3. Сопоставляем ID с объектами приложений
        const favApps = apps
            .filter(app => favoriteIds.includes(app.id))
            .map(app => {
                // формируем прямую ссылку
                const match = app.download_url.trim().match(/filehippo\.com\/([^/?#]+).*?/i);
                const slug = match ? match[1] : 'download_unknown';
                return { ...app, download_url: `https://filehippo.com/${slug}/post_download/` };
            });

        return favApps;

    } catch (err) {
        console.error(err);
        return [];
    }
}

// ------------------- ЗАГРУЗКА ПРИЛОЖЕНИЙ -------------------
async function loadApps() {
    const container = document.getElementById('appList'); 
    container.innerHTML = '<p>Загрузка...</p>';

    const token = localStorage.getItem('token');
    let favoriteIds = [];
if (token) {
    collection = await fetchCollection(); // теперь collection содержит реальные объекты
}


    try {
        const response = await fetch('https://corsproxy.io/?https://Cosmodesant.pythonanywhere.com/apps/');
        if (!response.ok) throw new Error('Ошибка: ' + response.status);
        const apps = await response.json();
        container.innerHTML = '';

        apps.forEach(app => {
            // Формируем прямую ссылку на скачивание через FileHippo
            let url = app.download_url.trim();
            const match = url.match(/filehippo\.com\/([^/?#]+).*?/i);
            const slug = match ? match[1] : 'download_unknown';
            const directUrl = `https://filehippo.com/${slug}/post_download/`;

            const card = document.createElement('div');
            card.className = 'card';

            // Определяем, добавлено ли в избранное
            const isFav = favoriteIds && favoriteIds.includes(app.id);

            let collectionBtn = '';
            if (token) {
                collectionBtn = `<button class="collection ${isFav ? 'added' : ''}">${isFav ? 'Добавлено' : '+ В коллекцию'}</button>`;
            }

            card.innerHTML = `
                <img src="${app.logo_url}" alt="${app.name}">
                <h3>${app.name}</h3>
                <p>${app.description}</p>
                <div class="actions" style="gap:10px;display:flex;justify-content:space-between;align-items:center;">
                    <a href="${directUrl}" target="_blank"
                       style="background:linear-gradient(90deg,#6a0dad,#9b4dff);color:white;padding:6px 12px;border-radius:8px;text-decoration:none;font-weight:500;">
                       Скачать
                    </a>
                    ${collectionBtn}
                </div>
            `;

            // Обработчик кнопки "Добавить в коллекцию"
            if (token && !isFav) {
                const btn = card.querySelector('.collection');
                btn.onclick = async () => {
                    try {
                        const res = await fetch('https://cosmodesant.pythonanywhere.com/api/auth/favorites/add/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ name: app.name })
                        });
                        if (res.ok) {
                            btn.textContent = 'Добавлено';
                            btn.classList.add('added');
                            collection.push({...app, download_url: directUrl});
                            renderCollection();
                        } else {
                            const data = await res.json();
                            alert(JSON.stringify(data));
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Ошибка добавления в коллекцию');
                    }
                };
            }

            container.appendChild(card);
        });

        renderCollection(); // сразу отрисовать коллекцию
    } catch (err) {
        console.error(err);
        container.innerHTML = '<p>Ошибка загрузки приложений.</p>';
    }
}

// ---------------- Коллекция ----------------
function renderCollection() {
    const list = document.getElementById('collectionList');
    list.innerHTML = collection.length ? '' : '<p>Коллекция пуста</p>';

    collection.forEach(app => {
        // Формируем прямую ссылку на скачивание
        let url = app.download_url.trim();
        const match = url.match(/filehippo\.com\/([^/?#]+).*?/i);
        const slug = match ? match[1] : 'download_unknown';
        const directUrl = `https://filehippo.com/${slug}/post_download/`;

        const div = document.createElement('div');
        div.className = 'collection-item';
        div.innerHTML = `
            <span>${app.name}</span>
            <a href="${directUrl}" target="_blank"
               class="download">
               Скачать
            </a>
        `;
        list.appendChild(div);
    });
}

// загрузка при старте
loadApps();

// ------------------- СТАРТОВАЯ ЗАГРУЗКА -------------------
loadApps();
</script>




</body>
</html>
